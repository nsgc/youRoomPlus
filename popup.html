<!DOCTYPE html><html>  <head>    <title>youRoomPlus</title>    <link type="text/css" href="jquery-ui-1.8.11.custom/css/ui-lightness/jquery-ui-1.8.11.custom.css" rel="Stylesheet"/>    <link type="text/css" href="base.css" rel="Stylesheet"/>    <script type="text/javascript" src="jquery-ui-1.8.11.custom/js/jquery-1.5.1.min.js"></script>    <script type="text/javascript" src="jquery-ui-1.8.11.custom/js/jquery-ui-1.8.11.custom.min.js"></script>    <script type="text/javascript" src="date.js"></script>    <script type="text/javascript">      $(function() {       var $tabs = $("#tabs").tabs();        $("#selectRoom").change(function () {          $("#homeTL").empty();          loadTimeLine($(this).val());          $tabs.tabs('select', 1); // switch to second tab          return false;        });        $("#selectRoom").focus(function () {          $("#homeTL").empty();          loadTimeLine($(this).val());          $tabs.tabs('select', 1); // switch to second tab          return false;        });        $("#home").click(function () {          $("#roomTL").empty();          loadTimeLine("all");          return false;        });      });      var bgPage = chrome.extension.getBackgroundPage();      function showNestedComments(obj){        var comment = "";        if (obj.children == null) {          return "";        } else {          jQuery.each(obj.children, function(){            comment = comment.concat("<dl><dt>", this.participation.name, "(", new Date(this.updated_at).dateFormat(), ")</dt><dd><section><p>", this.content, "</p><p class='toggleEntryArea' id='toggleEntryArea", this.id, "'>entry comment</p><footer style='display:none' id='footer", this.id, "'><textarea id='textArea", this.id, "'></textarea><button class='post' id='post", this.id, "'>post</button></footer></section>", showNestedComments(this), "</dd></dl>");          });          return comment;        }      };      function callbackPostEntry(resp, xhr){        var data = JSON.parse(resp);        var url = "https://www.youroom.in/r/" + data.entry.participation.group.to_param + "/entries/" + data.entry.root_id;        if ($("li.ui-tabs-selected").children()[0].toString().indexOf("#tab_home") > 0) {          getEntryFromHome(url);        } else if ($("li.ui-tabs-selected").children()[0].toString().indexOf("#tab_room") > 0) {          getEntry(url);        }      };      function postEntry(target_id, target_textArea, target_group){        var url = 'https://www.youroom.in/r/' + target_group + "/entries";        var request = { 'method': 'POST', 'parameters': {'format': 'json', 'entry[content]':  target_textArea , 'entry[parent_id]' : target_id}, 'headers': { 'Content-Type': 'application/xml'} };        bgPage.oauth.sendSignedRequest(url, callbackPostEntry, request);      };      function toggleTextArea(target_id){        $("#footer"+target_id).toggle("blind",{} ,0 );      };      var callbackShowEntryFromHome = function(resp, xhr) {        var data = JSON.parse(resp);        var list = "<dt>" + data.entry.participation.name + "(" + new Date(data.entry.updated_at).dateFormat() + ")" + "</dt>" + "<dd><section><p>" + data.entry.content + "</p><p class='toggleEntryArea' id='toggleEntryArea" + data.entry.id + "'>entry comment</p><footer style='display:none' id='footer" + data.entry.id + "'><textarea id='textArea" + data.entry.id + "'></textarea><button class='post' id='post" + data.entry.id + "'>post</button></footer></section>" +  showNestedComments(data.entry) + "</dd>";        $("#homeTL").html(list);        $("p.toggleEntryArea").click(function () {          toggleTextArea(this.id.slice("toggleEntryArea".length));          return false;        });        $("button.post").click(function () {          postEntry(this.id.slice("post".length), $("#textArea" + this.id.slice("post".length)).val(), $('#selectRoom option:selected').val());          return false;        });      };      var getEntryFromHome = function(url){        var request = { 'method': 'GET', 'parameters': {'format': 'json'} };        bgPage.oauth.sendSignedRequest(url, callbackShowEntryFromHome, request);      };      var callbackShowEntry = function(resp, xhr) {        var data = JSON.parse(resp);        var list = "<dt>" + data.entry.participation.name + "(" + new Date(data.entry.updated_at).dateFormat() + ")" + "</dt>" + "<dd><section><p>" + data.entry.content + "</p><p class='toggleEntryArea' id='toggleEntryArea" + data.entry.id + "'>entry comment</p><footer style='display:none' id='footer" + data.entry.id + "'><textarea id='textArea" + data.entry.id + "'></textarea><button class='post' id='post" + data.entry.id + "'>post</button></footer></section>" +  showNestedComments(data.entry) + "</dd>";        $("#roomTL").html(list);        $("p.toggleEntryArea").click(function () {          toggleTextArea(this.id.slice("toggleEntryArea".length));          return false;        });        $("button.post").click(function () {          postEntry(this.id.slice("post".length), $("#textArea" + this.id.slice("post".length)).val(), $('#selectRoom option:selected').val());          return false;        });      };      var getEntry = function(url){        var request = { 'method': 'GET', 'parameters': {'format': 'json'} };        bgPage.oauth.sendSignedRequest(url, callbackShowEntry, request);      };      var callbackMyGroups = function(resp, xhr) {        var data = JSON.parse(resp);        var opt = "";        jQuery.each(data, function(){          opt = opt.concat("<option value=", this.group.id, ">", this.group.name.substring(0, 10), "</option>");        });        $("#selectRoom").html(opt);      };      var loadMyGroups = function() {        var url = 'https://www.youroom.in/groups/my';        var request = { 'method': 'GET', 'parameters': {'format': 'json'} };        bgPage.oauth.sendSignedRequest(url, callbackMyGroups, request);      };      var callbackHomeTimeLine = function(resp, xhr) {        var data = JSON.parse(resp);        if(window.webkitNotifications.checkPermission() !== 0){          $("#block").html("<p class='message' onclick='permissionNotification();'>デスクトップ通知を許可</p>");        }        var list = "";        jQuery.each(data, function(){         var entryURL = "https://www.youroom.in/r/" + this.entry.participation.group.to_param +"/entries/" +this.entry.id;         list = list.concat("<dt>", this.entry.participation.name, "@", this.entry.participation.group.name, "(", new Date(this.entry.updated_at).dateFormat(), ")", "</dt><dd>", this.entry.content, "<p onclick=getEntryFromHome('", entryURL, "')>detail</p></dd>");        });        $("#homeTL").html(list);      };      var callbackRoomTimeLine = function(resp, xhr) {        var data = JSON.parse(resp);        var list = "";        jQuery.each(data, function(){          var entryURL = "https://www.youroom.in/r/" + $('#selectRoom option:selected').val() + "/entries/" + this.entry.id;          list = list.concat("<dt>", this.entry.participation.name, "(", new Date(this.entry.updated_at).dateFormat(), ")", "</dt><dd>", this.entry.content, "<p onclick=getEntry('", entryURL, "')>detail</p></dd>");        });        $("#roomTL").html(list);      };      var loadTimeLine = function(target) {        var url = 'https://www.youroom.in/';        var request = { 'method': 'GET', 'parameters': {'format': 'json'} };        if (target == "all" ) {          bgPage.oauth.sendSignedRequest(url, callbackHomeTimeLine, request);        } else {          bgPage.oauth.sendSignedRequest((url + "r/" + target), callbackRoomTimeLine, request);        }      };      function permissionNotification() {        window.webkitNotifications.requestPermission();        window.close();      };      bgPage.oauth.authorize(loadMyGroups);      loadTimeLine("all");    </script>  </head>  <body>    <div id="tabs">      <div id="block">      </div>      <ul>	<li><a href="#tab_home" id="home">HOME</a></li>	<li><a href="#tab_room"><select id="selectRoom"></select></a></li>      </ul>      <div id="tab_home">	<dl id="homeTL">	</dl>      </div>      <div id="tab_room">	<dl id="roomTL">	</dl>      </div>    </div>  </body></html>